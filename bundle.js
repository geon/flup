!function(e){var t={};function i(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=e,i.c=t,i.d=function(e,t,o){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(o,s,function(t){return e[t]}.bind(null,s));return o},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i(i.s=13)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Coord=void 0;class o{constructor(e){this.x=e.x,this.y=e.y}scaled(e){return o.scale(this,e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalized(){return o.scale(this,1/this.length())}static distance(e,t){return o.subtract(e,t).length()}static add(e,t){return new o({x:e.x+t.x,y:e.y+t.y})}static subtract(e,t){return new o({x:e.x-t.x,y:e.y-t.y})}static scale(e,t){return new o({x:e.x*t,y:e.y*t})}static interpolate(e,t,i){return o.add(o.scale(e,1-i),o.scale(t,i))}}t.Coord=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoardLogic=void 0;const o=i(0),s=i(14),r=i(5);class n{constructor(e){this.pieces=[],this.pieceCycle=e.pieceCycle,this.dropperQueue=e.dropperQueue,this.dropper=new s.Dropper(this.dropperQueue)}static xyToIndex(e,t){return e+t*n.size.x}static coordToIndex(e){return n.xyToIndex(e.x,e.y)}static indexToCoord(e){return new o.Coord({x:e%n.size.x,y:Math.floor(e/n.size.x)})}static getWidth(){return(n.size.x+2)*r.PieceSprite.size}static getHeight(){return(n.size.y+2)*r.PieceSprite.size}moveLeft(){return this.dropper.moveLeft()}moveRight(){return this.dropper.moveRight()}rotate(){return this.dropper.rotate()}drop(){const e=this.dropper.getDrops();if(e.some(e=>!!this.pieces[n.coordToIndex(e.coord)]))return[];for(const t of e)this.pieces[n.coordToIndex(t.coord)]=t.piece;const t=[];for(;;){t.push({type:"fall",movements:this.makePiecesFall()});const e=this.unlockChains();if(!e.length)break;t.push({type:"unlocking",unlockings:e})}return t.push(this.dropper.charge()),t}makePiecesFall(){const e=[];let t=[];for(let i=0;i<n.size.x;++i){let o=n.size.y-1;for(;o&&this.pieces[n.xyToIndex(i,o)];)--o;let s=o-1;e:for(;s>=0;){for(;!this.pieces[n.xyToIndex(i,s)];)if(--s,t=[],e.push(t),s<0)break e;const r=n.xyToIndex(i,s),a=n.xyToIndex(i,o);this.pieces[a]=this.pieces[r],this.pieces[r]=void 0;const h=this.pieces[a];t.push({sprite:h.sprite,to:n.indexToCoord(a)}),--s,--o}}return e}unlockChains(){const e=[],t=(t,i)=>{const o=this.pieces[t];this.pieces[t]=void 0,o&&e.push({sprite:o.sprite,depth:i,color:o.color})};for(const[e,i]of this.pieces.entries()){if(!i||!i.key)continue;const o=e=>{const t=this.pieces[e];return!!t&&t.color==i.color&&!t.key};if(this.neighborsOfPosition(e).some(o)){let i=[e],s=0;for(;i.length;){for(const e of i)t(e,s);++s,i=i.map(e=>this.neighborsOfPosition(e)).reduce((e,t)=>[...e,...t],[]).filter(o)}}}return e}neighborsOfPosition(e){const t=n.indexToCoord(e),i=[];return t.x<n.size.x-1&&i.push(e+1),t.x>0&&i.push(e-1),t.y<n.size.y-1&&i.push(e+n.size.x),t.y>0&&i.push(e-n.size.x),i}checkForGameOver(){return this.pieces.slice(0,2*n.size.x).some(e=>!!e)}punishLogic(e){const t=[];for(let e=0;e<n.size.y-1;e++)for(let i=0;i<n.size.x;i++){const o=n.xyToIndex(i,e+1),s=n.xyToIndex(i,e),r=this.pieces[o];this.pieces[s]=r,r&&t.push({to:n.indexToCoord(s),sprite:r.sprite})}return e.forEach((e,i)=>{const o=n.xyToIndex(i,n.size.y-1);this.pieces[o]=e,t.push({to:n.indexToCoord(o),sprite:e.sprite})}),t}}t.BoardLogic=n,n.size=new o.Coord({x:8,y:14})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpriteSheet=void 0;const o=i(15);t.SpriteSheet=class{constructor(e){this.imageFileName=e.imageFileName,this.gridSize=e.gridSize,this.spriteSettings=e.spriteSettings,this.image=new Image}loadImage(){return new Promise((e,t)=>{this.image.onload=(()=>e()),this.image.onerror=(()=>t(new Error("Could not load sprites."))),this.image.src="graphics/"+this.imageFileName})}getSprites(){const e={};for(const t of this.spriteSettings)e[t.name]=new o.Sprite(this,t.sheetPosition,t.sheetSize);return e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.easings=t.makeIterable=t.queue=t.parallel=t.animateInterpolation=t.waitMs=void 0,t.waitMs=function*(e){let t=0;for(;t<e;)t+=(yield);return t},t.animateInterpolation=function*(e,t){let i=0;for(;i<e;)t(i/e),i+=(yield);return t(1),i},t.parallel=function*(e){let t=e.slice();for(;t.length;){const e=yield;for(let i=0;i<t.length;++i)t[i].next(e).done&&t.splice(i,1)}},t.queue=function*(e){for(const t of e)yield*t},t.makeIterable=function*(e){e()};const o=e=>(Math.cos((1-e)*Math.PI)+1)/2;t.easings={linear:e=>e,easeInQuad:e=>e*e,sine:o,sine2:e=>o(o(e))}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PieceCycle=void 0;class o{constructor(e){this.currentIndex=0,this.pieces=e}pop(){const e=this.pieces[this.currentIndex];return this.currentIndex=(this.currentIndex+1)%this.pieces.length,e}static generate(){const e=[],t=[];for(let i=0;i<this.numColors;++i)e[i]={color:i,key:!1},t[i]={color:i,key:!0};let i=t;for(let t=0;t<this.nonKeyToKeyRatio;++t)i=i.concat(e);let o=[];for(let e=0;e<32;++e)this.fisherYatesArrayShuffle(i),o=o.concat(i);return o}static fisherYatesArrayShuffle(e){let t=e.length;if(0!==t)for(;--t;){const i=Math.floor(Math.random()*(t+1)),o=e[t],s=e[i];e[t]=s,e[i]=o}}}t.PieceCycle=o,o.numColors=4,o.nonKeyToKeyRatio=5},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PieceSprite=void 0;const o=i(0),s=i(4),r=i(2),n=i(3);class a{constructor(e){this.spriteName=(e.key?"key":"piece")+e.color,this.position=e.position,this.accumulatedDeltaTime=0,this.frameCoroutine=this.makeFrameCoroutine()}static getSprites(){return a.sprites||(a.sprites=a.getSpriteSheet().getSprites()),a.sprites}static getSpriteSheet(){return a.spriteSheet||(a.spriteSheet=new r.SpriteSheet(a.getSpriteSheetSettings())),a.spriteSheet}static getSpriteSheetSettings(){const e=[];for(let t=0;t<s.PieceCycle.numColors;++t)e.push({name:"piece"+t,sheetPosition:new o.Coord({x:0,y:t}),sheetSize:new o.Coord({x:1,y:1})}),e.push({name:"key"+t,sheetPosition:new o.Coord({x:1,y:t}),sheetSize:new o.Coord({x:1,y:1})});return{imageFileName:"pieces.png",gridSize:new o.Coord({x:4,y:4}),spriteSettings:e}}*makeFrameCoroutine(){for(;;){const e=yield;if(this.accumulatedDeltaTime+=e,this.animationCoroutine){this.animationCoroutine.next(e).done&&(this.animationCoroutine=void 0)}}}queueUpAnimation(e){this.animationCoroutine=this.animationCoroutine?(0,n.queue)([this.animationCoroutine,e]):e}*makeMoveCoroutine({to:e,duration:t,easing:i}){const s=this.position;yield*(0,n.animateInterpolation)(t,t=>{this.position=o.Coord.interpolate(s,e,i(t))})}draw(e,t,i,s,r){const n=s*(a.size*i*.05*Math.sin(this.accumulatedDeltaTime/1e3*27+this.position.x+3*this.position.y)),h=s*(a.size*i*.05*Math.sin(this.accumulatedDeltaTime/1e3*21+this.position.y+2*this.position.x)),c=s*(a.size*i*.1*Math.sin(this.accumulatedDeltaTime/1e3*13+this.position.y+5*this.position.x));a.getSprites()[this.spriteName].draw(e,new o.Coord({x:t.x+(this.position.x/r.x-.5)*r.x*a.size*i+a.size/2-.5*(a.size+c)+n,y:t.y+(this.position.y/r.y-.5)*r.y*a.size*i+a.size/2-.5*(a.size+c)+h}),new o.Coord({x:a.size*i,y:a.size*i}))}}t.PieceSprite=a,a.size=32},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Avatar=void 0;t.Avatar=class{constructor(){this.colorGenerator=this.generatePunishColors(),this.frameCoroutine=this.makeFrameCoroutine()}getPunishColors(){return this.colorGenerator.next().value}}},function(e,t,i){"use strict";var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(s,r){function n(e){try{h(o.next(e))}catch(e){r(e)}}function a(e){try{h(o.throw(e))}catch(e){r(e)}}function h(e){e.done?s(e.value):function(e){return e instanceof i?e:new i(function(t){t(e)})}(e.value).then(n,a)}h((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0}),t.App=void 0;const s=i(8),r=i(9),n=i(0),a=i(16),h=i(5),c=i(2),d=i(10),p=i(11);class u{constructor(e){this.context=e.context,this.gameMode=new a.GameMode2pAi,this.lastRenderTime=0;const t=()=>{this.context.canvas.width=window.innerWidth*window.devicePixelRatio,this.context.canvas.height=window.innerHeight*window.devicePixelRatio,this.context.canvas.style.width=window.innerWidth+"px",this.context.canvas.style.height=window.innerHeight+"px",this.context.scale(window.devicePixelRatio,window.devicePixelRatio)};window.onresize=t,t()}static getSprites(){return this.sprites||(this.sprites=this.getSpriteSheet().getSprites()),this.sprites}static getSpriteSheet(){return this.spriteSheet||(this.spriteSheet=new c.SpriteSheet(this.getSpriteSheetSettings())),this.spriteSheet}static getSpriteSheetSettings(){const e=new n.Coord({x:4,y:2}),t=[];for(let i=0;i<e.x*e.y;++i)t.push({name:i.toString(),sheetPosition:new n.Coord({x:i%e.x,y:Math.floor(i/e.x)}),sheetSize:new n.Coord({x:1,y:1})});return{imageFileName:"slates.jpg",gridSize:e,spriteSettings:t}}getWidth(){return this.context.canvas.width/window.devicePixelRatio}getHeight(){return this.context.canvas.height/window.devicePixelRatio}loadSprites(){return Promise.all([h.PieceSprite.getSpriteSheet().loadImage(),d.UnlockingEffect.getSpriteSheet().loadImage(),r.AvatarOwl.getSpriteSheet().loadImage(),s.AvatarAztecJade.getSpriteSheet().loadImage(),p.AvatarMonolith.getSpriteSheet().loadImage(),u.getSpriteSheet().loadImage()])}startGame(){return o(this,void 0,void 0,function*(){window.addEventListener("keyup",e=>{this.keydownEventInProgress=void 0},!1),window.addEventListener("keydown",e=>{this.keydownEventInProgress!==e.keyCode&&this.gameMode.onKeyDown(e.keyCode),this.keydownEventInProgress=e.keyCode},!1),yield this.loadSprites(),yield this.startRenderLoop()})}startRenderLoop(){return o(this,void 0,void 0,function*(){for(;;){const e=yield new Promise(e=>{(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(e=>{window.setTimeout(e,1e3/60,(new Date).getTime())}))(e)}),t=Math.min(e-this.lastRenderTime,100);this.lastRenderTime=e;this.gameMode.frameCoroutine.next(t).done;this.render()}})}render(){this.context.fillStyle="rgba(0, 0, 0, 1)",this.context.fillRect(0,0,this.getWidth(),this.getHeight()),this.gameMode.draw(this.context,new n.Coord({x:this.getWidth(),y:this.getHeight()}))}}t.App=u},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AvatarAztecJade=void 0;const o=i(6),s=i(1),r=i(0),n=i(4),a=i(2),h=i(3),c=1,d=.98*c,p=.8*c,u=1.1*c;function l(e,t){return i=>e*(1-i)+t*i}class m extends o.Avatar{constructor(){super(),this.diskSizeFactor=c,this.currentDiskSprite="gold",this.currentBodySprite="idol",this.animationQueue=[]}getSize(){return m.size}static getSprites(){return m.sprites||(m.sprites=m.getSpriteSheet().getSprites()),m.sprites}static getSpriteSheet(){return m.spriteSheet||(m.spriteSheet=new a.SpriteSheet(m.getSpriteSheetSettings())),m.spriteSheet}static getSpriteSheetSettings(){const e=[{name:"gold",sheetPosition:new r.Coord({x:0,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"clay",sheetPosition:new r.Coord({x:1,y:0}),sheetSize:new r.Coord({x:0,y:0})},{name:"idol",sheetPosition:new r.Coord({x:0,y:1}),sheetSize:new r.Coord({x:1,y:1})},{name:"shards",sheetPosition:new r.Coord({x:1,y:1}),sheetSize:new r.Coord({x:0,y:1})}];return{imageFileName:"aztec-jade.png",gridSize:new r.Coord({x:2,y:2}),spriteSettings:e}}onUnlock(){this.animationQueue.push(this.makeUnlockCoroutine())}onPunish(){this.animationQueue.push(this.makePunishCoroutine())}onWin(){this.animationQueue.push(this.makeWinCoroutine())}onLose(){this.animationQueue.push(this.makeLoseCoroutine())}*generatePunishColors(){let e=0;for(;;){++e;const t=[];for(let i=0;i<s.BoardLogic.size.x;i++)t.push(Math.floor((e+i)/2)%n.PieceCycle.numColors);yield t}}*makeFrameCoroutine(){for(;;){yield*this.animationQueue.shift()||this.makeIdleCoroutine()}}*makeUnlockCoroutine(){const e=l(c,p);yield*(0,h.animateInterpolation)(200,t=>{this.diskSizeFactor=e(h.easings.sine2(t))}),yield*(0,h.animateInterpolation)(200,t=>{this.diskSizeFactor=e(h.easings.sine2(1-t))})}*makePunishCoroutine(){}*makeWinCoroutine(){for(yield*(0,h.animateInterpolation)(200,e=>{this.diskSizeFactor=h.easings.sine2(l(c,u)(e))});;){const e=l(u,c);yield*(0,h.animateInterpolation)(200,t=>{this.diskSizeFactor=e(h.easings.sine2(t))}),yield*(0,h.animateInterpolation)(200,t=>{this.diskSizeFactor=e(h.easings.sine2(1-t))})}}*makeLoseCoroutine(){this.currentDiskSprite="clay",this.currentBodySprite="shards"}*makeIdleCoroutine(){const e=l(c,d);for(let t=0;t<2;++t)yield*(0,h.animateInterpolation)(100,t=>{this.diskSizeFactor=e(h.easings.sine2(t))}),yield*(0,h.animateInterpolation)(100,t=>{this.diskSizeFactor=e(h.easings.sine2(1-t))});yield*(0,h.waitMs)(1200)}draw(e,t){const i=m.getSprites(),o=new r.Coord({x:m.size,y:m.size});i[this.currentDiskSprite].draw(e,r.Coord.subtract(t,r.Coord.scale(o,.5*this.diskSizeFactor)),r.Coord.scale(o,this.diskSizeFactor)),i[this.currentBodySprite].draw(e,r.Coord.subtract(t,r.Coord.scale(o,.5)),o)}}t.AvatarAztecJade=m,m.size=256},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AvatarOwl=void 0;const o=i(6),s=i(1),r=i(0),n=i(4),a=i(2),h=i(3);class c extends o.Avatar{constructor(){super(),this.bobFactor=0,this.currentWingSprite="wingsClosed",this.currentHeadSprite="head",this.animationQueue=[]}getSize(){return c.size}static getSprites(){return c.sprites||(c.sprites=c.getSpriteSheet().getSprites()),c.sprites}static getSpriteSheet(){return c.spriteSheet||(c.spriteSheet=new a.SpriteSheet(c.getSpriteSheetSettings())),c.spriteSheet}static getSpriteSheetSettings(){const e=[{name:"head",sheetPosition:new r.Coord({x:0,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"headSpin1",sheetPosition:new r.Coord({x:1,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"headSpin2",sheetPosition:new r.Coord({x:2,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"headSpin3",sheetPosition:new r.Coord({x:3,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"headSpin4",sheetPosition:new r.Coord({x:4,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"headSpin5",sheetPosition:new r.Coord({x:5,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"body",sheetPosition:new r.Coord({x:0,y:1}),sheetSize:new r.Coord({x:1,y:1})},{name:"wingsClosed",sheetPosition:new r.Coord({x:1,y:1}),sheetSize:new r.Coord({x:0,y:0})},{name:"wingsTransition1",sheetPosition:new r.Coord({x:2,y:1}),sheetSize:new r.Coord({x:0,y:0})},{name:"wingsTransition2",sheetPosition:new r.Coord({x:3,y:1}),sheetSize:new r.Coord({x:0,y:0})},{name:"wingsTransition3",sheetPosition:new r.Coord({x:4,y:1}),sheetSize:new r.Coord({x:0,y:0})},{name:"wingsOpen",sheetPosition:new r.Coord({x:5,y:1}),sheetSize:new r.Coord({x:0,y:0})}];return{imageFileName:"owl.png",gridSize:new r.Coord({x:6,y:2}),spriteSettings:e}}onUnlock(){this.animationQueue.push(this.makeUnlockCoroutine())}onPunish(){this.animationQueue.push(this.makePunishCoroutine())}onWin(){this.animationQueue.push(this.makeWinCoroutine())}onLose(){this.animationQueue.push(this.makeLoseCoroutine())}*generatePunishColors(){for(;;){const e=[];for(let t=0;t<s.BoardLogic.size.x;t++)e.push(t%n.PieceCycle.numColors);yield e}}*makeFrameCoroutine(){for(;;){yield*this.animationQueue.shift()||this.makeIdleCoroutine()}}*makeUnlockCoroutine(){const e=[{name:"wingsTransition1",time:50},{name:"wingsTransition2",time:50},{name:"wingsTransition3",time:50},{name:"wingsOpen",time:1e3},{name:"wingsTransition3",time:50},{name:"wingsTransition2",time:50},{name:"wingsTransition1",time:50},{name:"wingsClosed",time:0}];for(const t of e)this.currentWingSprite=t.name,yield*(0,h.waitMs)(t.time)}*makePunishCoroutine(){}*makeWinCoroutine(){const e=[{name:"wingsTransition1",time:50},{name:"wingsTransition2",time:50},{name:"wingsTransition3",time:50},{name:"wingsOpen",time:50},{name:"wingsTransition3",time:50},{name:"wingsTransition2",time:50},{name:"wingsTransition1",time:50},{name:"wingsClosed",time:50}];for(;;)for(const t of e)this.currentWingSprite=t.name,yield*(0,h.waitMs)(t.time)}*makeLoseCoroutine(){const e=["headSpin1","headSpin2","headSpin3","headSpin4","headSpin5","head"];for(;;){for(const t of e)this.currentHeadSprite=t,yield*(0,h.waitMs)(50);yield*(0,h.waitMs)(200)}}*makeIdleCoroutine(){yield*(0,h.waitMs)(600),yield*(0,h.animateInterpolation)(300,e=>{this.bobFactor=0+1*h.easings.sine(e)}),yield*(0,h.animateInterpolation)(300,e=>{this.bobFactor=1-2*h.easings.sine(e)}),yield*(0,h.animateInterpolation)(300,e=>{this.bobFactor=1*h.easings.sine(e)-1})}draw(e,t){const i=c.getSprites(),o=new r.Coord({x:c.size,y:c.size});i[this.currentWingSprite].draw(e,r.Coord.subtract(t,r.Coord.scale(o,.5)),o),i.body.draw(e,r.Coord.subtract(t,r.Coord.scale(o,.5)),o),i[this.currentHeadSprite].draw(e,r.Coord.add(new r.Coord({x:0,y:2*this.bobFactor}),r.Coord.subtract(t,r.Coord.scale(o,.5))),o)}}t.AvatarOwl=c,c.size=256},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnlockingEffect=void 0;const o=i(0),s=i(5),r=i(2);class n{constructor(e,t){this.color=e,this.coord=t,this.accumulatedDeltaTime=0,this.initialVelocities=[];for(let e=0;e<8;e++)this.initialVelocities[e]=new o.Coord({x:1.5*(2*Math.random()-1),y:2*(2*Math.random()-1)-.4}).scaled(.35);this.frameCoroutine=this.makeFrameCoroutine()}*makeFrameCoroutine(){for(;;){const e=yield;if(this.accumulatedDeltaTime+=e,this.accumulatedDeltaTime>n.duration)return}}draw(e,t,i,r){const a=new o.Coord({x:t.x+(this.coord.x/r.x-.5)*r.x*s.PieceSprite.size*i+s.PieceSprite.size/2-.5*n.size,y:t.y+(this.coord.y/r.y-.5)*r.y*s.PieceSprite.size*i+s.PieceSprite.size/2-.5*n.size});for(let t=0;t<this.initialVelocities.length;t++)n.getSprites()["color "+this.color+", variation "+t].draw(e,new o.Coord({x:a.x+this.initialVelocities[t].x*this.accumulatedDeltaTime,y:a.y+this.initialVelocities[t].y*this.accumulatedDeltaTime+n.gravity*this.accumulatedDeltaTime*this.accumulatedDeltaTime}),new o.Coord({x:n.size*i,y:n.size*i}))}}t.UnlockingEffect=n,n.size=16,n.gravity=.001,n.duration=3e3,n.getSprites=(()=>(n.sprites||(n.sprites=n.getSpriteSheet().getSprites()),n.sprites)),n.getSpriteSheet=(()=>(n.spriteSheet||(n.spriteSheet=new r.SpriteSheet(n.getSpriteSheetSettings())),n.spriteSheet)),n.getSpriteSheetSettings=(()=>{const e=[];for(let t=0;t<4;++t)for(let i=0;i<8;++i)e.push({name:"color "+t+", variation "+i,sheetPosition:new o.Coord({x:4+i%4,y:2*t+Math.floor(i/4)}),sheetSize:new o.Coord({x:1,y:1})});return{imageFileName:"pieces.png",gridSize:new o.Coord({x:8,y:8}),spriteSettings:e}})},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AvatarMonolith=void 0;const o=i(6),s=i(1),r=i(0),n=i(4),a=i(2),h=i(3);class c extends o.Avatar{constructor(){super(),this.currentBaseSprite="base",this.hasWriting=!1,this.hasGalaxy=!1,this.animationQueue=[]}getSize(){return c.size}static getSprites(){return c.sprites||(c.sprites=c.getSpriteSheet().getSprites()),c.sprites}static getSpriteSheet(){return c.spriteSheet||(c.spriteSheet=new a.SpriteSheet(c.getSpriteSheetSettings())),c.spriteSheet}static getSpriteSheetSettings(){const e=[{name:"base",sheetPosition:new r.Coord({x:0,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"writing",sheetPosition:new r.Coord({x:1,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"glass",sheetPosition:new r.Coord({x:2,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"galaxy",sheetPosition:new r.Coord({x:3,y:0}),sheetSize:new r.Coord({x:1,y:1})}];return{imageFileName:"monolith.png",gridSize:new r.Coord({x:4,y:1}),spriteSettings:e}}onUnlock(){this.animationQueue.push(this.makeUnlockCoroutine())}onPunish(){this.animationQueue.push(this.makePunishCoroutine())}onWin(){this.animationQueue.push(this.makeWinCoroutine())}onLose(){this.animationQueue.push(this.makeLoseCoroutine())}*generatePunishColors(){let e=0;for(;;){for(let t=0;t<2;++t){const t=[];for(let i=0;i<s.BoardLogic.size.x;i++)t.push(Math.floor((e+i)/2)%n.PieceCycle.numColors);yield t}e+=2}}*makeFrameCoroutine(){for(;;){yield*this.animationQueue.shift()||this.makeIdleCoroutine()}}*makeUnlockCoroutine(){for(let e=0;e<3;++e)this.hasGalaxy=!0,yield*(0,h.waitMs)(50),this.hasGalaxy=!1,yield*(0,h.waitMs)(50);this.hasGalaxy=!0,yield*(0,h.waitMs)(1e3),this.hasGalaxy=!1}*makePunishCoroutine(){for(let e=0;e<3;++e)this.hasWriting=!0,yield*(0,h.waitMs)(50),this.hasWriting=!1,yield*(0,h.waitMs)(50);this.hasWriting=!0,yield*(0,h.waitMs)(1e3),this.hasWriting=!1}*makeWinCoroutine(){this.hasGalaxy=!0,this.currentBaseSprite="glass"}*makeLoseCoroutine(){this.hasWriting=!0}*makeIdleCoroutine(){yield}draw(e,t){const i=c.getSprites(),o=new r.Coord({x:c.size,y:c.size});this.hasGalaxy&&i.galaxy.draw(e,r.Coord.subtract(t,r.Coord.scale(o,.5)),o),i[this.currentBaseSprite].draw(e,r.Coord.subtract(t,r.Coord.scale(o,.5)),o),this.hasWriting&&i.writing.draw(e,r.Coord.subtract(t,r.Coord.scale(o,.5)),o)}}t.AvatarMonolith=c,c.size=256},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Player=void 0;t.Player=class{constructor(e){this.board=e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=new(i(7).App)({context:document.getElementsByTagName("canvas")[0].getContext("2d")});try{o.startGame()}catch(e){console.error("Could not start game.",e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Dropper=void 0;const o=i(1),s=i(0);t.Dropper=class{constructor(e){this.dropperQueue=e,this.pose={position:Math.floor((o.BoardLogic.size.x-1)/2),orientation:"horizontal"}}moveLeft(){return this.pose.position=Math.max(0,this.pose.position-1),this.animate()}moveRight(){return this.pose.position=Math.min(o.BoardLogic.size.x-("vertical"==this.pose.orientation?1:2),this.pose.position+1),this.animate()}rotate(){if(this.pose.orientation="vertical"==this.pose.orientation?"horizontal":"vertical","horizontal"==this.pose.orientation){const e=this.pieceA;this.pieceA=this.pieceB,this.pieceB=e}return this.preventDropperFromStickingOutAfterRotation(),this.animate()}preventDropperFromStickingOutAfterRotation(){"horizontal"==this.pose.orientation&&this.pose.position>=o.BoardLogic.size.x-1&&(this.pose.position=o.BoardLogic.size.x-2)}getDrops(){const e=this.getCoordinates();return[{coord:e.a,piece:this.pieceA},{coord:e.b,piece:this.pieceB}]}getCoordinates(){return{a:new s.Coord({x:this.pose.position,y:0}),b:new s.Coord({x:this.pose.position+("horizontal"===this.pose.orientation?1:0),y:"vertical"===this.pose.orientation?1:0})}}charge(){const e=this.getCoordinates(),t=this.dropperQueue.pop();return"left"==this.dropperQueue.dropperSide&&"horizontal"==this.pose.orientation?(this.pieceA=t.b,this.pieceB=t.a):(this.pieceA=t.a,this.pieceB=t.b),{type:"charge",a:{sprite:this.pieceA.sprite,to:e.a},b:{sprite:this.pieceB.sprite,to:e.b},queueMovements:t.queueMovements}}animate(){const e=this.getCoordinates();return{type:"move",movements:[{sprite:this.pieceA.sprite,to:e.a},{sprite:this.pieceB.sprite,to:e.b}]}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Sprite=void 0;t.Sprite=class{constructor(e,t,i){this.sheetPosition=t,this.sheetSize=i,this.spriteSheet=e}draw(e,t,i){e.drawImage(this.spriteSheet.image,this.sheetPosition.x*this.spriteSheet.image.width/this.spriteSheet.gridSize.x,this.sheetPosition.y*this.spriteSheet.image.height/this.spriteSheet.gridSize.y,this.spriteSheet.image.width/this.spriteSheet.gridSize.x,this.spriteSheet.image.height/this.spriteSheet.gridSize.y,t.x,t.y,i.x,i.y)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameMode2pAi=void 0;const o=i(8),s=i(9),r=i(17),n=i(1),a=i(0),h=i(4),c=i(11),d=i(19),p=i(20);function u(e){return e[Math.floor(Math.random()*e.length)]}t.GameMode2pAi=class{constructor(){const e=h.PieceCycle.generate();this.boards=[new r.Board({pieceCycle:new h.PieceCycle(e),gameMode:this,dropperSide:"right"}),new r.Board({pieceCycle:new h.PieceCycle(e),gameMode:this,dropperSide:"left"})];const t=[s.AvatarOwl,o.AvatarAztecJade,c.AvatarMonolith];this.avatars=[new(u(t)),new(u(t))],this.isGameOver=!1,this.frameCoroutine=this.makeFrameCoroutine(),this.human=new p.LocalHuman(this.boards[1],[38,37,40,39])}onUnlockedChains(e,t){this.punishOpponents(e,t);const i=this.boards.indexOf(e);this.avatars[i].onUnlock()}punishOpponents(e,t){for(let i=0;i<this.boards.length;i++)if(this.boards[i]!==e){const e=Math.max(0,t-1);e&&(this.boards[i].punish(this.avatars[i],e),this.avatars[i].onPunish())}}onGameOver(e){this.isGameOver=!0;const t=this.boards.indexOf(e);this.avatars[t].onLose(),this.avatars.filter((e,i)=>i!=t).forEach(e=>{e.onWin()})}onKeyDown(e){this.isGameOver||this.human.onKeyDown(e)}*makeFrameCoroutine(){const e=new d.OcdBot(this.boards[0]).makeCoroutine();for(;;){const t=yield;this.isGameOver||e.next(t),this.boards.map(e=>e.frameCoroutine).forEach(e=>e.next(t)),this.avatars.map(e=>e.frameCoroutine).forEach(e=>e.next(t))}}draw(e,t){const i=new a.Coord({x:t.x/2,y:t.y/2}),o=.66*n.BoardLogic.getWidth();this.boards[0].draw(e,new a.Coord({x:i.x-o,y:i.y}),1),this.boards[1].draw(e,new a.Coord({x:i.x+o,y:i.y}),1);const s=.75*n.BoardLogic.getWidth(),r=n.BoardLogic.getHeight()/2*1.1;this.avatars[0].draw(e,new a.Coord({x:i.x-o-s,y:i.y+r-this.avatars[0].getSize()/2})),this.avatars[1].draw(e,new a.Coord({x:i.x+o+s,y:i.y+r-this.avatars[1].getSize()/2}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Board=void 0;const o=i(3),s=i(7),r=i(0),n=i(18),a=i(5),h=i(10),c=i(1);function d(e){throw new Error("Unknown case.")}t.Board=class{constructor(e){this.gameMode=e.gameMode,this.frameCoroutine=this.makeFrameCoroutine(),this.piecesSprites=new Set;const t=new n.DropperQueue({pieceCycle:e.pieceCycle,board:this},e.dropperSide);this.boardLogic=new c.BoardLogic({pieceCycle:e.pieceCycle,dropperQueue:t}),this.unlockingEffects=new Set,this.eventQueue=[],this.eventQueue.push(this.boardLogic.dropper.charge()),this.slateRandomExp=2+Math.random()}makePiece(e){const t=new a.PieceSprite(e);return this.piecesSprites.add(t),{color:e.color,key:e.key,sprite:t}}*makeGameLogicCoroutine(){for(;;){let e,t=0;for(;e=this.eventQueue.shift();)switch(e.type){case"charge":yield*(0,o.parallel)([e.a.sprite.makeMoveCoroutine({to:e.a.to,duration:50*r.Coord.distance(e.a.sprite.position,e.a.to),easing:o.easings.sine}),e.b.sprite.makeMoveCoroutine({to:e.b.to,duration:50*r.Coord.distance(e.b.sprite.position,e.b.to),easing:o.easings.sine}),...e.queueMovements.map(e=>e.sprite.makeMoveCoroutine({to:e.to,duration:150,easing:o.easings.sine}))]);break;case"move":yield*(0,o.parallel)(e.movements.map(e=>e.sprite.makeMoveCoroutine({to:e.to,duration:50,easing:o.easings.sine})));break;case"fall":const i=100;yield*(0,o.parallel)(e.movements.map(e=>(0,o.parallel)(e.map((e,t)=>(0,o.queue)([(0,o.waitMs)(50*t),e.sprite.makeMoveCoroutine({to:e.to,duration:Math.sqrt(r.Coord.distance(e.sprite.position,e.to))*i,easing:o.easings.easeInQuad})])))));break;case"unlocking":++t,yield*(0,o.parallel)(e.unlockings.map(e=>(0,o.queue)([(0,o.waitMs)(50*e.depth),(0,o.makeIterable)(()=>{this.piecesSprites.delete(e.sprite),this.unlockingEffects.add(new h.UnlockingEffect(e.color,e.sprite.position))})])));break;case"punish":yield*(0,o.queue)(e.movements.map(e=>(0,o.parallel)(e.map(e=>e.sprite.makeMoveCoroutine({to:e.to,duration:100,easing:o.easings.sine})))));break;default:d(e)}if(t&&this.gameMode.onUnlockedChains(this,t),this.boardLogic.checkForGameOver()){this.gameMode.onGameOver(this),yield*this.startGameOverEffect();break}yield}}moveLeft(){this.eventQueue.push(this.boardLogic.moveLeft())}moveRight(){this.eventQueue.push(this.boardLogic.moveRight())}rotate(){this.eventQueue.push(this.boardLogic.rotate())}drop(){this.eventQueue.push(...this.boardLogic.drop())}*startGameOverEffect(){yield*(0,o.parallel)(this.boardLogic.pieces.filter(e=>!!e).map(e=>(0,o.queue)([(0,o.waitMs)(100*r.Coord.distance(e.sprite.position,r.Coord.scale(c.BoardLogic.size,.5))),(0,o.makeIterable)(()=>{this.piecesSprites.delete(e.sprite),this.unlockingEffects.add(new h.UnlockingEffect(e.color,e.sprite.position))})])))}punish(e,t){const i=[];for(let o=0;o<t;++o){const t=e.getPunishColors().map((e,t)=>{const i=new r.Coord({x:t,y:c.BoardLogic.size.y});return this.makePiece({color:e,key:!1,position:i})}),o=this.boardLogic.punishLogic(t);i.push(o)}this.eventQueue.push({type:"punish",movements:i})}*makeFrameCoroutine(){const e=this.makeGameLogicCoroutine();for(;;){const t=yield;e.next(t);for(const e of this.piecesSprites)e.frameCoroutine.next(t);for(const e of this.unlockingEffects)e.frameCoroutine.next(t).done&&this.unlockingEffects.delete(e)}}draw(e,t,i){const o=s.App.getSprites();for(let s=0;s<c.BoardLogic.size.y;++s)for(let n=0;n<c.BoardLogic.size.x;++n){const h=8,d=2,p=Math.floor(Math.pow(113+n+s*c.BoardLogic.size.y,this.slateRandomExp)),u=p%d,l=p%h-d+d;o[Math.floor(p/13)%10?u:l].draw(e,new r.Coord({x:t.x+(n-c.BoardLogic.size.x/2)*i*a.PieceSprite.size,y:t.y+(s-c.BoardLogic.size.y/2)*i*a.PieceSprite.size}),new r.Coord({x:a.PieceSprite.size*i,y:a.PieceSprite.size*i}))}let n=0;for(let e=0;e<this.boardLogic.pieces.length;e++)if(this.boardLogic.pieces[e]){const t=c.BoardLogic.indexToCoord(e);n=c.BoardLogic.size.y-1-t.y;break}const h=n/(c.BoardLogic.size.y-2-1),d=h<.65?0:(h-.65)/.35;for(const o of this.unlockingEffects)o.draw(e,t,i,c.BoardLogic.size);for(const o of this.piecesSprites)o.draw(e,t,i,d,c.BoardLogic.size)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DropperQueue=void 0;const o=i(0),s=i(1);class r{constructor(e,t){for(this.board=e.board,this.pieceCycle=e.pieceCycle,this.dropperSide=t,this.pieces=[];this.pieces.length<r.dropperQueueVisibleLength;){const e=this.pieceCycle.pop();this.pieces.push(this.board.makePiece({color:e.color,key:e.key,position:new o.Coord({x:"left"==this.dropperSide?-1:s.BoardLogic.size.x,y:this.pieces.length})}))}}pop(){return this.pushSingle(r.dropperQueueVisibleLength),this.pushSingle(r.dropperQueueVisibleLength+1),{a:this.pieces.shift(),b:this.pieces.shift(),queueMovements:this.pieces.map((e,t)=>({sprite:e.sprite,to:new o.Coord({x:"left"==this.dropperSide?-1:s.BoardLogic.size.x,y:t})}))}}pushSingle(e){const t=this.pieceCycle.pop();this.pieces.push(this.board.makePiece({color:t.color,key:t.key,position:new o.Coord({x:"left"==this.dropperSide?-1:s.BoardLogic.size.x,y:e})}))}}t.DropperQueue=r,r.dropperQueueVisibleLength=s.BoardLogic.size.y,r.dropperQueueTimePerPieceWidth=200},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OcdBot=void 0;const o=i(3),s=i(12);function r(e){const t=[0,1,2,3,1,3,0,2],i=[e.pieceA.color,e.pieceB.color];if(i[0]===i[1])for(let e=0;e<t.length;++e)if(t[e]===i[0])return{matchingPose:{position:e,orientation:"vertical"},ascending:!1};for(let e=0;e<t.length-1;++e)if(t[e]===i[0]&&t[e+1]===i[1])return{matchingPose:{position:e,orientation:"horizontal"},ascending:i[0]<i[1]};i.reverse();let o=0;for(;o<t.length-1&&(t[o]!==i[0]||t[o+1]!==i[1]);++o);return{matchingPose:{position:o,orientation:"horizontal"},ascending:i[0]<i[1]}}t.OcdBot=class extends s.Player{*makeCoroutine(){for(;;){yield*(0,o.waitMs)(500);const e=this.board.boardLogic.dropper,{matchingPose:t,ascending:i}=r(e);let s;for(;s=this.nextMoveToGetToPose(e.pose,t,i);)yield*(0,o.waitMs)(150),s();yield*(0,o.waitMs)(200),this.board.drop()}}nextMoveToGetToPose(e,t,i){const o=this.board.boardLogic.dropper,s=[o.pieceA.color,o.pieceB.color];return e.orientation!=t.orientation?()=>this.board.rotate():i!==s[0]<s[1]?()=>this.board.rotate():e.position<t.position?()=>this.board.moveRight():e.position>t.position?()=>this.board.moveLeft():void 0}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalHuman=void 0;const o=i(12);t.LocalHuman=class extends o.Player{constructor(e,t){super(e),this.keys=t}onKeyDown(e){if(!this.board.boardLogic.checkForGameOver())switch(e){case this.keys[1]:this.board.moveLeft();break;case this.keys[3]:this.board.moveRight();break;case this.keys[0]:this.board.rotate();break;case this.keys[2]:this.board.drop()}}}}]);