!function(e){var t={};function i(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=e,i.c=t,i.d=function(e,t,o){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(o,s,function(t){return e[t]}.bind(null,s));return o},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i(i.s=11)}([function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class o{constructor(e){this.x=e.x,this.y=e.y}scaled(e){return o.scale(this,e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalized(){return o.scale(this,1/this.length())}static distance(e,t){return o.subtract(e,t).length()}static add(e,t){return new o({x:e.x+t.x,y:e.y+t.y})}static subtract(e,t){return new o({x:e.x-t.x,y:e.y-t.y})}static scale(e,t){return new o({x:e.x*t,y:e.y*t})}static interpolate(e,t,i){return o.add(o.scale(e,1-i),o.scale(t,i))}}t.Coord=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(0),s=i(12),r=i(3);class n{constructor(e){this.pieces=[],this.pieceCycle=e.pieceCycle,this.dropperQueue=e.dropperQueue,this.dropper=new s.Dropper(this.dropperQueue)}static xyToIndex(e,t){return e+t*n.size.x}static coordToIndex(e){return n.xyToIndex(e.x,e.y)}static indexToCoord(e){return new o.Coord({x:e%n.size.x,y:Math.floor(e/n.size.x)})}static getWidth(){return(n.size.x+2)*r.PieceSprite.size}static getHeight(){return(n.size.y+2)*r.PieceSprite.size}moveLeft(){return this.dropper.moveLeft()}moveRight(){return this.dropper.moveRight()}rotate(){return this.dropper.rotate()}drop(){const e=this.dropper.getDrops();if(e.some(e=>!!this.pieces[n.coordToIndex(e.coord)]))return[];for(const t of e)this.pieces[n.coordToIndex(t.coord)]=t.piece;const t=[];for(;;){t.push({type:"fall",movements:this.makePiecesFall()});const e=this.unlockChains();if(!e.length)break;t.push({type:"unlocking",unlockings:e})}return t.push(this.dropper.charge()),t}makePiecesFall(){const e=[];let t=[];for(let i=0;i<n.size.x;++i){let o=n.size.y-1;for(;o&&this.pieces[n.xyToIndex(i,o)];)--o;let s=o-1;e:for(;s>=0;){for(;!this.pieces[n.xyToIndex(i,s)];)if(--s,t=[],e.push(t),s<0)break e;const r=n.xyToIndex(i,s),a=n.xyToIndex(i,o);this.pieces[a]=this.pieces[r],this.pieces[r]=void 0;const c=this.pieces[a];t.push({sprite:c.sprite,to:n.indexToCoord(a)}),--s,--o}}return e}unlockChains(){const e=[],t=(t,i)=>{const o=this.pieces[t];this.pieces[t]=void 0,o&&e.push({sprite:o.sprite,depth:i,color:o.color})};for(const[e,i]of this.pieces.entries()){if(!i||!i.key)continue;const o=e=>{const t=this.pieces[e];return!!t&&t.color==i.color};if(this.neighborsOfPosition(e).some(o)){let i=[e],s=0;for(;i.length;){for(const e of i)t(e,s);++s,i=i.map(e=>this.neighborsOfPosition(e)).reduce((e,t)=>[...e,...t],[]).filter(o)}}}return e}neighborsOfPosition(e){const t=n.indexToCoord(e),i=[];return t.x<n.size.x-1&&i.push(e+1),t.x>0&&i.push(e-1),t.y<n.size.y-1&&i.push(e+n.size.x),t.y>0&&i.push(e-n.size.x),i}checkForGameOver(){return this.pieces.slice(0,2*n.size.x).some(e=>!!e)}punishLogic(e){const t=[];for(let e=0;e<n.size.y-1;e++)for(let i=0;i<n.size.x;i++){const o=n.xyToIndex(i,e+1),s=n.xyToIndex(i,e),r=this.pieces[o];this.pieces[s]=r,r&&t.push({to:n.indexToCoord(s),sprite:r.sprite})}return e.forEach((e,i)=>{const o=n.xyToIndex(i,n.size.y-1);this.pieces[o]=e,t.push({to:n.indexToCoord(o),sprite:e.sprite})}),t}}n.size=new o.Coord({x:8,y:18}),t.BoardLogic=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(13);t.SpriteSheet=class{constructor(e){this.imageFileName=e.imageFileName,this.gridSize=e.gridSize,this.spriteSettings=e.spriteSettings,this.image=new Image}loadImage(){return new Promise((e,t)=>{this.image.onload=(()=>e()),this.image.onerror=(e=>t(new Error("Could not load sprites. "+e.message))),this.image.src="graphics/"+this.imageFileName})}getSprites(){const e={};for(const t of this.spriteSettings)e[t.name]=new o.Sprite(this,t.sheetPosition,t.sheetSize);return e}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(0),s=i(4),r=i(2),n=i(5);class a{constructor(e){this.spriteName=(e.key?"key":"piece")+e.color,this.position=e.position,this.accumulatedDeltaTime=0,this.frameCoroutine=this.makeFrameCoroutine()}static getSprites(){return a.sprites||(a.sprites=a.getSpriteSheet().getSprites()),a.sprites}static getSpriteSheet(){return a.spriteSheet||(a.spriteSheet=new r.SpriteSheet(a.getSpriteSheetSettings())),a.spriteSheet}static getSpriteSheetSettings(){const e=[];for(let t=0;t<s.PieceCycle.numColors;++t)e.push({name:"piece"+t,sheetPosition:new o.Coord({x:0,y:t}),sheetSize:new o.Coord({x:1,y:1})}),e.push({name:"key"+t,sheetPosition:new o.Coord({x:1,y:t}),sheetSize:new o.Coord({x:1,y:1})});return{imageFileName:"pieces.png",gridSize:new o.Coord({x:4,y:4}),spriteSettings:e}}*makeFrameCoroutine(){for(;;){const e=yield;if(this.animationCoroutine){this.animationCoroutine.next(e).done&&(this.animationCoroutine=void 0)}}}queueUpAnimation(e){this.animationCoroutine=this.animationCoroutine?n.queue([this.animationCoroutine,e]):e}*makeMoveCoroutine({to:e,duration:t,easing:i}){const s=this.position;yield*n.animateInterpolation(t,t=>{this.position=o.Coord.interpolate(s,e,i(t))})}draw(e,t,i,s,r,n){this.accumulatedDeltaTime+=t;const c=r*(a.size*s*.05*Math.sin(this.accumulatedDeltaTime/1e3*27+this.position.x+3*this.position.y)),h=r*(a.size*s*.05*Math.sin(this.accumulatedDeltaTime/1e3*21+this.position.y+2*this.position.x)),d=r*(a.size*s*.1*Math.sin(this.accumulatedDeltaTime/1e3*13+this.position.y+5*this.position.x));a.getSprites()[this.spriteName].draw(e,new o.Coord({x:i.x+(this.position.x/n.x-.5)*n.x*a.size*s+a.size/2-.5*(a.size+d)+c,y:i.y+(this.position.y/n.y-.5)*n.y*a.size*s+a.size/2-.5*(a.size+d)+h}),new o.Coord({x:a.size*s,y:a.size*s}))}}a.size=32,t.PieceSprite=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class o{constructor(e){this.currentIndex=0,this.pieces=e}pop(){const e=this.pieces[this.currentIndex];return this.currentIndex=(this.currentIndex+1)%this.pieces.length,e}static generate(){const e=[],t=[];for(let i=0;i<this.numColors;++i)e[i]={color:i,key:!1},t[i]={color:i,key:!0};let i=t;for(let t=0;t<this.nonKeyToKeyRatio;++t)i=i.concat(e);let o=[];for(let e=0;e<32;++e)this.fisherYatesArrayShuffle(i),o=o.concat(i);return o}static fisherYatesArrayShuffle(e){let t=e.length;if(0!==t)for(;--t;){const i=Math.floor(Math.random()*(t+1)),o=e[t],s=e[i];e[t]=s,e[i]=o}}}o.numColors=4,o.nonKeyToKeyRatio=7,t.PieceCycle=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.waitMs=function*(e){let t=0;for(;t<e;)t+=(yield);return t},t.animateInterpolation=function*(e,t){let i=0;for(;i<e;)t(i/e),i+=(yield);return t(1),i},t.parallel=function*(e){let t=e.slice();for(;t.length;){const e=yield;for(let i=0;i<t.length;++i)t[i].next(e).done&&t.splice(i,1)}},t.queue=function*(e){for(const t of e)yield*t},t.makeIterable=function*(e){e()},t.easings={linear:e=>e,easeInQuad:e=>e*e,sine:e=>(Math.cos((1-e)*Math.PI)+1)/2}},function(e,t,i){"use strict";var o=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(s,r){function n(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){e.done?s(e.value):new i(function(t){t(e.value)}).then(n,a)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const s=i(7),r=i(9),n=i(0),a=i(14),c=i(3),h=i(2),d=i(10);class p{constructor(e){this.context=e.context,this.gameMode=new a.GameMode2pLocal,this.lastRenderTime=0;const t=()=>{this.context.canvas.width=window.innerWidth*window.devicePixelRatio,this.context.canvas.height=window.innerHeight*window.devicePixelRatio,this.context.canvas.style.width=window.innerWidth+"px",this.context.canvas.style.height=window.innerHeight+"px",this.context.scale(window.devicePixelRatio,window.devicePixelRatio)};window.onresize=t,t()}static getSprites(){return this.sprites||(this.sprites=this.getSpriteSheet().getSprites()),this.sprites}static getSpriteSheet(){return this.spriteSheet||(this.spriteSheet=new h.SpriteSheet(this.getSpriteSheetSettings())),this.spriteSheet}static getSpriteSheetSettings(){const e=new n.Coord({x:4,y:2}),t=[];for(let i=0;i<e.x*e.y;++i)t.push({name:i.toString(),sheetPosition:new n.Coord({x:i%e.x,y:Math.floor(i/e.x)}),sheetSize:new n.Coord({x:1,y:1})});return{imageFileName:"slates.jpg",gridSize:e,spriteSettings:t}}getWidth(){return this.context.canvas.width/window.devicePixelRatio}getHeight(){return this.context.canvas.height/window.devicePixelRatio}loadSprites(){return Promise.all([c.PieceSprite.getSpriteSheet().loadImage(),d.UnlockingEffect.getSpriteSheet().loadImage(),r.AvatarOwl.getSpriteSheet().loadImage(),s.AvatarAztecJade.getSpriteSheet().loadImage(),p.getSpriteSheet().loadImage()])}startGame(){return o(this,void 0,void 0,function*(){window.addEventListener("keyup",e=>{this.keydownEventInProgress=void 0},!1),window.addEventListener("keydown",e=>{this.keydownEventInProgress!==e.keyCode&&this.gameMode.onKeyDown(e.keyCode),this.keydownEventInProgress=e.keyCode},!1),yield this.loadSprites(),yield this.startRenderLoop()})}startRenderLoop(){return o(this,void 0,void 0,function*(){for(;;){const e=yield new Promise(e=>{(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||(e=>{window.setTimeout(e,1e3/60,(new Date).getTime())}))(e)}),t=Math.min(e-this.lastRenderTime,100);this.lastRenderTime=e;const i=this.gameMode.frameCoroutine.next(t).done;this.render(t),i&&console.log("Game Over")}})}render(e){this.context.fillStyle="rgba(0, 0, 0, 1)",this.context.fillRect(0,0,this.getWidth(),this.getHeight()),this.gameMode.draw(this.context,e,new n.Coord({x:this.getWidth(),y:this.getHeight()}))}}t.App=p},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(8),s=i(1),r=i(0),n=i(4),a=i(2);class c extends o.Avatar{constructor(){super(),this.accumulatedDeltaTime=0}getSize(){return c.size}static getSprites(){return c.sprites||(c.sprites=c.getSpriteSheet().getSprites()),c.sprites}static getSpriteSheet(){return c.spriteSheet||(c.spriteSheet=new a.SpriteSheet(c.getSpriteSheetSettings())),c.spriteSheet}static getSpriteSheetSettings(){const e=[{name:"gold",sheetPosition:new r.Coord({x:0,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"clay",sheetPosition:new r.Coord({x:1,y:0}),sheetSize:new r.Coord({x:0,y:0})},{name:"idol",sheetPosition:new r.Coord({x:0,y:1}),sheetSize:new r.Coord({x:1,y:1})},{name:"shards",sheetPosition:new r.Coord({x:1,y:1}),sheetSize:new r.Coord({x:0,y:1})}];return{imageFileName:"aztec-jade.png",gridSize:new r.Coord({x:2,y:2}),spriteSettings:e}}*generatePunishColors(){let e=0;for(;;){++e;const t=[];for(let i=0;i<s.BoardLogic.size.x;i++)t.push(Math.floor((e+i)/2)%n.PieceCycle.numColors);yield t}}draw(e,t,i){this.accumulatedDeltaTime+=t;const o=c.getSprites(),s=new r.Coord({x:c.size,y:c.size}),n=1-(1+Math.sin(this.accumulatedDeltaTime/1e3*3))/2*.1;o.gold.draw(e,r.Coord.subtract(i,r.Coord.scale(s,.5*n)),r.Coord.scale(s,n)),o.idol.draw(e,r.Coord.subtract(i,r.Coord.scale(s,.5)),s)}}c.size=256,t.AvatarAztecJade=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Avatar=class{constructor(){this.colorGenerator=this.generatePunishColors()}getPunishColors(){return this.colorGenerator.next().value}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(8),s=i(1),r=i(0),n=i(4),a=i(2);class c extends o.Avatar{constructor(){super(),this.accumulatedDeltaTime=0}getSize(){return c.size}static getSprites(){return c.sprites||(c.sprites=c.getSpriteSheet().getSprites()),c.sprites}static getSpriteSheet(){return c.spriteSheet||(c.spriteSheet=new a.SpriteSheet(c.getSpriteSheetSettings())),c.spriteSheet}static getSpriteSheetSettings(){const e=[{name:"head",sheetPosition:new r.Coord({x:0,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"headSpin1",sheetPosition:new r.Coord({x:0,y:0}),sheetSize:new r.Coord({x:1,y:1})},{name:"headSpin2",sheetPosition:new r.Coord({x:0,y:0}),sheetSize:new r.Coord({x:2,y:1})},{name:"headSpin3",sheetPosition:new r.Coord({x:0,y:0}),sheetSize:new r.Coord({x:3,y:1})},{name:"headSpin4",sheetPosition:new r.Coord({x:0,y:0}),sheetSize:new r.Coord({x:4,y:1})},{name:"headSpin5",sheetPosition:new r.Coord({x:0,y:0}),sheetSize:new r.Coord({x:5,y:1})},{name:"body",sheetPosition:new r.Coord({x:0,y:1}),sheetSize:new r.Coord({x:1,y:1})},{name:"wingsClosed",sheetPosition:new r.Coord({x:1,y:1}),sheetSize:new r.Coord({x:0,y:0})},{name:"wingsTransition1",sheetPosition:new r.Coord({x:2,y:1}),sheetSize:new r.Coord({x:0,y:0})},{name:"wingsTransition2",sheetPosition:new r.Coord({x:3,y:1}),sheetSize:new r.Coord({x:0,y:0})},{name:"wingsTransition3",sheetPosition:new r.Coord({x:4,y:1}),sheetSize:new r.Coord({x:0,y:0})},{name:"wingsOpen",sheetPosition:new r.Coord({x:5,y:1}),sheetSize:new r.Coord({x:0,y:0})}];return{imageFileName:"owl.png",gridSize:new r.Coord({x:6,y:2}),spriteSettings:e}}*generatePunishColors(){for(;;){const e=[];for(let t=0;t<s.BoardLogic.size.x;t++)e.push(t%n.PieceCycle.numColors);yield e}}draw(e,t,i){this.accumulatedDeltaTime+=t;const o=c.getSprites(),s=new r.Coord({x:c.size,y:c.size});o[c.wingFlapCycle.getCurrentFrameName()].draw(e,r.Coord.subtract(i,r.Coord.scale(s,.5)),s),o.body.draw(e,r.Coord.subtract(i,r.Coord.scale(s,.5)),s);const n=Math.sin(this.accumulatedDeltaTime/200);o.head.draw(e,r.Coord.add(new r.Coord({x:0,y:2*n}),r.Coord.subtract(i,r.Coord.scale(s,.5))),s)}}c.size=256,c.wingFlapCycle={frames:[{name:"wingsClosed",time:2e3},{name:"wingsTransition1",time:50},{name:"wingsTransition2",time:50},{name:"wingsTransition3",time:50},{name:"wingsOpen",time:1e3},{name:"wingsTransition3",time:50},{name:"wingsTransition2",time:50},{name:"wingsTransition1",time:50}],currentFrameIndex:0,frameTimer:void 0,getCurrentFrameName:()=>(c.wingFlapCycle.frameTimer||(c.wingFlapCycle.frameTimer=setTimeout(()=>{++c.wingFlapCycle.currentFrameIndex,c.wingFlapCycle.currentFrameIndex%=c.wingFlapCycle.frames.length,c.wingFlapCycle.frameTimer=void 0},c.wingFlapCycle.frames[c.wingFlapCycle.currentFrameIndex].time)),c.wingFlapCycle.frames[c.wingFlapCycle.currentFrameIndex].name)},t.AvatarOwl=c},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(0),s=i(3),r=i(2),n=i(5);class a{constructor(e,t){this.color=e,this.coord=t,this.accumulatedDeltaTime=0,this.initialVelocities=[];for(let e=0;e<8;e++)this.initialVelocities[e]=new o.Coord({x:.75*(2*Math.random()-1),y:2*Math.random()-1-.2}).scaled(.35);this.frameCoroutine=this.makeFrameCoroutine()}*makeFrameCoroutine(){yield*n.waitMs(a.duration)}draw(e,t,i,r,n){this.accumulatedDeltaTime+=t;const c=new o.Coord({x:i.x+(this.coord.x/n.x-.5)*n.x*s.PieceSprite.size*r+s.PieceSprite.size/2-.5*a.size,y:i.y+(this.coord.y/n.y-.5)*n.y*s.PieceSprite.size*r+s.PieceSprite.size/2-.5*a.size});for(let t=0;t<this.initialVelocities.length;t++)a.getSprites()["color "+this.color+", variation "+t].draw(e,new o.Coord({x:c.x+this.initialVelocities[t].x*this.accumulatedDeltaTime,y:c.y+this.initialVelocities[t].y*this.accumulatedDeltaTime+a.gravity*this.accumulatedDeltaTime*this.accumulatedDeltaTime}),new o.Coord({x:a.size*r,y:a.size*r}));this.accumulatedDeltaTime+=t}}a.size=16,a.gravity=5e-4,a.duration=3e3,a.getSprites=(()=>(a.sprites||(a.sprites=a.getSpriteSheet().getSprites()),a.sprites)),a.getSpriteSheet=(()=>(a.spriteSheet||(a.spriteSheet=new r.SpriteSheet(a.getSpriteSheetSettings())),a.spriteSheet)),a.getSpriteSheetSettings=(()=>{const e=[];for(let t=0;t<4;++t)for(let i=0;i<8;++i)e.push({name:"color "+t+", variation "+i,sheetPosition:new o.Coord({x:4+i%4,y:2*t+Math.floor(i/4)}),sheetSize:new o.Coord({x:1,y:1})});return{imageFileName:"pieces.png",gridSize:new o.Coord({x:8,y:8}),spriteSettings:e}}),t.UnlockingEffect=a},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=new(i(6).App)({context:document.getElementsByTagName("canvas")[0].getContext("2d")});try{o.startGame()}catch(e){console.error("Could not start game.",e)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(1),s=i(0);t.Dropper=class{constructor(e){this.dropperQueue=e,this.position=Math.floor((o.BoardLogic.size.x-1)/2),this.orientation="horizontal"}moveLeft(){return this.position=Math.max(0,this.position-1),this.animate()}moveRight(){return this.position=Math.min(o.BoardLogic.size.x-("vertical"==this.orientation?1:2),this.position+1),this.animate()}rotate(){if(this.orientation="vertical"==this.orientation?"horizontal":"vertical","horizontal"==this.orientation){const e=this.pieceA;this.pieceA=this.pieceB,this.pieceB=e}return this.preventDropperFromStickingOutAfterRotation(),this.animate()}preventDropperFromStickingOutAfterRotation(){"horizontal"==this.orientation&&this.position>=o.BoardLogic.size.x-1&&(this.position=o.BoardLogic.size.x-2)}getDrops(){const e=this.getCoordinates();return[{coord:e.a,piece:this.pieceA},{coord:e.b,piece:this.pieceB}]}getCoordinates(){return{a:new s.Coord({x:this.position,y:0}),b:new s.Coord({x:this.position+("horizontal"===this.orientation?1:0),y:"vertical"===this.orientation?1:0})}}charge(){const e=this.getCoordinates(),t=this.dropperQueue.pop();return"left"==this.dropperQueue.dropperSide&&"horizontal"==this.orientation?(this.pieceA=t.b,this.pieceB=t.a):(this.pieceA=t.a,this.pieceB=t.b),{type:"charge",a:{sprite:this.pieceA.sprite,to:e.a},b:{sprite:this.pieceB.sprite,to:e.b},queueMovements:t.queueMovements}}animate(){const e=this.getCoordinates();return{type:"move",movements:[{sprite:this.pieceA.sprite,to:e.a},{sprite:this.pieceB.sprite,to:e.b}]}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Sprite=class{constructor(e,t,i){this.sheetPosition=t,this.sheetSize=i,this.spriteSheet=e}draw(e,t,i){e.drawImage(this.spriteSheet.image,this.sheetPosition.x*this.spriteSheet.image.width/this.spriteSheet.gridSize.x,this.sheetPosition.y*this.spriteSheet.image.height/this.spriteSheet.gridSize.y,this.spriteSheet.image.width/this.spriteSheet.gridSize.x,this.spriteSheet.image.height/this.spriteSheet.gridSize.y,t.x,t.y,i.x,i.y)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(7),s=i(9),r=i(15),n=i(1),a=i(0),c=i(4);t.GameMode2pLocal=class{constructor(){const e=c.PieceCycle.generate();this.boards=[new r.Board({pieceCycle:new c.PieceCycle(e),gameMode:this,dropperSide:"right"}),new r.Board({pieceCycle:new c.PieceCycle(e),gameMode:this,dropperSide:"left"})],this.avatars=[new s.AvatarOwl,new o.AvatarAztecJade],this.isGameOver=!1,this.frameCoroutine=this.makeFrameCoroutine()}onUnlockedChains(e,t){this.punishOpponents(e,t)}punishOpponents(e,t){for(let i=0;i<this.boards.length;i++)if(this.boards[i]!==e){const e=Math.max(0,t-1);e&&this.boards[i].punish(this.avatars[i],e)}}onGameOver(){this.isGameOver=!0}onKeyDown(e){if(!this.isGameOver)switch(event.keyCode){case 37:this.boards[1].moveLeft();break;case 39:this.boards[1].moveRight();break;case 38:this.boards[1].rotate();break;case 40:this.boards[1].drop();break;case"A".charCodeAt(0):this.boards[0].moveLeft();break;case"D".charCodeAt(0):this.boards[0].moveRight();break;case"W".charCodeAt(0):this.boards[0].rotate();break;case"S".charCodeAt(0):this.boards[0].drop();break;case"Q".charCodeAt(0):this.punishOpponents(this.boards[0],4)}}*makeFrameCoroutine(){for(;;){const e=yield;if(this.boards.map(e=>e.frameCoroutine).forEach(t=>t.next(e)),this.isGameOver)break}}draw(e,t,i){const o=new a.Coord({x:i.x/2,y:i.y/2}),s=.66*n.BoardLogic.getWidth();this.boards[0].draw(e,t,new a.Coord({x:o.x-s,y:o.y}),1),this.boards[1].draw(e,t,new a.Coord({x:o.x+s,y:o.y}),1);const r=.75*n.BoardLogic.getWidth(),c=n.BoardLogic.getHeight()/2*1.1;this.avatars[0].draw(e,t,new a.Coord({x:o.x-s-r,y:o.y+c-this.avatars[0].getSize()/2})),this.avatars[1].draw(e,t,new a.Coord({x:o.x+s+r,y:o.y+c-this.avatars[1].getSize()/2}))}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(5),s=i(6),r=i(0),n=i(16),a=i(3),c=i(10),h=i(1);function d(e){throw new Error("Unknown case.")}t.Board=class{constructor(e){this.gameMode=e.gameMode,this.frameCoroutine=this.makeFrameCoroutine(),this.piecesSprites=new Set;const t=new n.DropperQueue({pieceCycle:e.pieceCycle,board:this},e.dropperSide);this.boardLogic=new h.BoardLogic({pieceCycle:e.pieceCycle,dropperQueue:t}),this.unlockingEffects=new Set,this.eventQueue=[],this.eventQueue.push(this.boardLogic.dropper.charge()),this.slateRandomExp=2+Math.random()}makePiece(e){const t=new a.PieceSprite(e);return this.piecesSprites.add(t),{color:e.color,key:e.key,sprite:t}}*makeGameLogicCoroutine(){for(;;){let e,t=0;for(;e=this.eventQueue.shift();)switch(e.type){case"charge":yield*o.parallel([e.a.sprite.makeMoveCoroutine({to:e.a.to,duration:50*r.Coord.distance(e.a.sprite.position,e.a.to),easing:o.easings.sine}),e.b.sprite.makeMoveCoroutine({to:e.b.to,duration:50*r.Coord.distance(e.b.sprite.position,e.b.to),easing:o.easings.sine}),...e.queueMovements.map(e=>e.sprite.makeMoveCoroutine({to:e.to,duration:150,easing:o.easings.sine}))]);break;case"move":yield*o.parallel(e.movements.map(e=>e.sprite.makeMoveCoroutine({to:e.to,duration:50,easing:o.easings.sine})));break;case"fall":const i=100;yield*o.parallel(e.movements.map(e=>o.parallel(e.map((e,t)=>o.queue([o.waitMs(50*t),e.sprite.makeMoveCoroutine({to:e.to,duration:Math.sqrt(r.Coord.distance(e.sprite.position,e.to))*i,easing:o.easings.easeInQuad})])))));break;case"unlocking":++t,yield*o.parallel(e.unlockings.map(e=>o.queue([o.waitMs(50*e.depth),o.makeIterable(()=>{this.piecesSprites.delete(e.sprite),this.unlockingEffects.add(new c.UnlockingEffect(e.color,e.sprite.position))})])));break;case"punish":yield*o.queue(e.movements.map(e=>o.parallel(e.map(e=>e.sprite.makeMoveCoroutine({to:e.to,duration:100,easing:o.easings.sine})))));break;default:d(e)}if(t&&this.gameMode.onUnlockedChains(this,t),this.boardLogic.checkForGameOver()){yield*this.startGameOverEffect();break}yield}}moveLeft(){this.eventQueue.push(this.boardLogic.moveLeft())}moveRight(){this.eventQueue.push(this.boardLogic.moveRight())}rotate(){this.eventQueue.push(this.boardLogic.rotate())}drop(){this.eventQueue.push(...this.boardLogic.drop())}*startGameOverEffect(){yield*o.parallel(this.boardLogic.pieces.filter(e=>!!e).map(e=>o.queue([o.waitMs(100*r.Coord.distance(e.sprite.position,r.Coord.scale(h.BoardLogic.size,.5))),o.makeIterable(()=>{this.piecesSprites.delete(e.sprite),this.unlockingEffects.add(new c.UnlockingEffect(e.color,e.sprite.position))})])))}punish(e,t){const i=[];for(let o=0;o<t;++o){const t=e.getPunishColors().map((e,t)=>{const i=new r.Coord({x:t,y:h.BoardLogic.size.y});return this.makePiece({color:e,key:!1,position:i})}),o=this.boardLogic.punishLogic(t);i.push(o)}this.eventQueue.push({type:"punish",movements:i})}*makeFrameCoroutine(){const e=this.makeGameLogicCoroutine();for(;;){const t=yield;if(e.next(t).done)break;for(const e of this.piecesSprites)e.frameCoroutine.next(t);for(const e of this.unlockingEffects)e.frameCoroutine.next(t).done&&this.unlockingEffects.delete(e)}}draw(e,t,i,o){const n=s.App.getSprites();for(let t=0;t<h.BoardLogic.size.y;++t)for(let s=0;s<h.BoardLogic.size.x;++s){const c=8,d=2,p=Math.floor(Math.pow(113+s+t*h.BoardLogic.size.y,this.slateRandomExp)),l=p%d,u=p%c-d+d;n[Math.floor(p/13)%10?l:u].draw(e,new r.Coord({x:i.x+(s-h.BoardLogic.size.x/2)*o*a.PieceSprite.size,y:i.y+(t-h.BoardLogic.size.y/2)*o*a.PieceSprite.size}),new r.Coord({x:a.PieceSprite.size*o,y:a.PieceSprite.size*o}))}let c=0;for(let e=0;e<this.boardLogic.pieces.length;e++)if(this.boardLogic.pieces[e]){const t=h.BoardLogic.indexToCoord(e);c=h.BoardLogic.size.y-1-t.y;break}const d=c/(h.BoardLogic.size.y-2-1),p=d<.65?0:(d-.65)/.35;for(const s of this.unlockingEffects)s.draw(e,t,i,o,h.BoardLogic.size);for(const s of this.piecesSprites)s.draw(e,t,i,o,p,h.BoardLogic.size)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=i(0),s=i(1);class r{constructor(e,t){for(this.board=e.board,this.pieceCycle=e.pieceCycle,this.dropperSide=t,this.pieces=[];this.pieces.length<r.dropperQueueVisibleLength;){const e=this.pieceCycle.pop();this.pieces.push(this.board.makePiece({color:e.color,key:e.key,position:new o.Coord({x:"left"==this.dropperSide?-1:s.BoardLogic.size.x,y:this.pieces.length})}))}}pop(){return this.pushSingle(r.dropperQueueVisibleLength),this.pushSingle(r.dropperQueueVisibleLength+1),{a:this.pieces.shift(),b:this.pieces.shift(),queueMovements:this.pieces.map((e,t)=>({sprite:e.sprite,to:new o.Coord({x:"left"==this.dropperSide?-1:s.BoardLogic.size.x,y:t})}))}}pushSingle(e){const t=this.pieceCycle.pop();this.pieces.push(this.board.makePiece({color:t.color,key:t.key,position:new o.Coord({x:"left"==this.dropperSide?-1:s.BoardLogic.size.x,y:e})}))}}r.dropperQueueVisibleLength=18,r.dropperQueueTimePerPieceWidth=200,t.DropperQueue=r}]);